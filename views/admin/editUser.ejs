<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit User</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="../img/favicons/rounded-background-favicon.ico"
    />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/page-loader.css" />
    <link rel="stylesheet" href="/css/editUser.css" />

    <!-- Page Loader -->



    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Toastify -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
      .ButtonDicoration {
        color: white !important;
        background-color: #121212 !important;
        border: 1px solid #121212 !important;
      }

      .ButtonDicoration:hover {
        color: #121212 !important;
        background-color: white !important;
      }
    </style>
  </head>
  <body>
    <div class="containerr">
      <div class="addusercard row justify-content-center">
        <div class="col-md-20">
          <div class="form-wrapper">
            <h2 class="text-center mb-4">Edit User</h2>
            <form id="editUserForm">
                <div class="mb-3">
                    <label for="user-id" class="form-label">User_ID</label>
                    <p id="user-id" class="form-control"><%= user._id %></p>
                  </div>
                  <div class="mb-3 text-center">
                    <label for="profile-picture" class="form-label"
                      >Profile Picture</label
                    >
                    <div class="d-flex flex-column align-items-center">
                      <img
                        id="profile-picture-preview"
                        src="<%= user.profilePic %>"
                        alt="Profile Preview"
                        class="rounded-circle mb-2"
                        style="
                          width: 120px;
                          height: 120px;
                          object-fit: cover;
                          border: 2px solid #ccc;
                        "
                      />
  
                      <!-- Hidden file input -->
                      <input
                        type="file"
                        class="d-none"
                        id="profile-picture"
                        name="profilePicture"
                        accept="image/*"
                      />
  
                      <!-- Custom styled button -->
                      <button
                        type="button"
                        class="btn btn-outline-primary btn-sm mt-2 ButtonDicoration"
                        onclick="document.getElementById('profile-picture').click();"
                        style="width: 120px"
                      >
                        Upload Picture
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-primary btn-sm mt-2 ButtonDicoration"
                        id="reset-profile-picture"
                        style="width: 120px"
                      >
                        Default Picture
                      </button>
                    </div>
                  </div>
              <div class="mb-3">
                <label for="user-name" class="form-label">Full Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="user-name"
                  value="<%= user.name %>"
                  name="name"
                />
              </div>

              
               

              <div class="mb-3">
                <label for="user-email" class="form-label"
                  >Email address</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="user-email"
                  value="<%= user.email %>"
                  name="email"
                />
              </div>

              <div class="mb-3">
                <label for="newPassword" class="form-label">Old Password</label>
                <div class="input-group">
                  <input
                    name="password"
                    type="password"
                    class="form-control"
                    id="user-oldPassword"
                    placeholder="Enter Old password*"
                  />
                  <span
                    class="input-group-text password-toggle"
                    id="signupPasswordToggle"
                  >
                    <i class="fa-solid fa-lock" id="signupPasswordIcon"></i>
                  </span>
                </div>
              </div>
              <div class="mb-3">
                <label for="oldPassword" class="form-label"
                  >New Password</label
                >
                <div class="input-group">
                  <input
                    name="Confirm Password"
                    type="password"
                    class="form-control"
                    id="user-newPassword"
                    placeholder="Enter New password*"
                  />
                  <span
                    class="input-group-text password-toggle"
                    id="confirmPasswordToggle"
                  >
                    <i class="fa-solid fa-lock" id="confirmPasswordIcon"></i>
                  </span>
                </div>
              </div>

              <div class="mb-2">
                <label for="user-phone" class="form-label">Phone Number</label>
                <div class="input-group">
                  <span class="input-group-text" id="phone">+20</span>
                  <input
                    type="tel"
                    name="tel"
                    class="form-control"
                    value="<%= user.phone %>"
                    aria-label="Phone"
                    aria-describedby="phone"
                    maxlength="10"
                    id="user-phone"
                    pattern="\d{10}"
                    inputmode="numeric"
                    oninput="this.value = this.value.replace(/\D/g, '')"
                  />
                </div>
                <% if (user.role) { %>
                <div class="mb-3">
                  <label for="role" class="form-label">Role</label>
                  <select id="user-role" class="form-select">
                    <option value="user" <%= user.role === 'user' ? 'selected' :
                    '' %>> User</option>
                    <option value="admin" <%= user.role === 'admin' ?
                    'selected' : '' %>> Admin</option>
                  </select>
                </div>
                <% } %>
              </div>

              <% if (user.isVerified !== undefined) { %>
                <div class="mb-3">
                  <label for="isVerified" class="form-label">Verified</label>
                  <select id="user-isVerified" class="form-select">
                    <option value="true" <%= user.isVerified === true ? 'selected' : '' %>> True</option>
                    <option value="false" <%= user.isVerified === false ? 'selected' : '' %>> False</option>
                  </select>
                </div>
              <% } %>
            

              <p class="signup-confirm-password"></p>
              <button
                type="submit"
                id="signup-button-diffcolor"
                class="signupButton btn btn-primary w-100"
              >
                Edit User
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import showFunToast from "/js/toast.js";
      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("profile-picture");
        const preview = document.getElementById("profile-picture-preview");
        const resetButton = document.getElementById("reset-profile-picture");

        fileInput.addEventListener("change", function (event) {
          const file = event.target.files[0];

          if (file) {
            preview.src = URL.createObjectURL(file);
          }
        });
        resetButton.addEventListener("click", function () {
         preview.src = "/uploads/defaultProfilePic.png"; // üëà Set back to your default profile picture path
         fileInput.value = ""; // üëà Clear the file input (remove selected file)
      });
      });

      const form = document.getElementById("editUserForm");
      
      // Save the initial values when the page loads
      const originalValues = {
        id: document.getElementById("user-id").textContent.trim(),
        name: document.getElementById("user-name").value,
        email: document.getElementById("user-email").value,
        phone: document.getElementById("user-phone")?.value || "",
        role: document.getElementById("user-role")?.value || "",
        isVerified: document.getElementById("user-isVerified")?.value || "",
        oldPassword: document.getElementById("user-oldPassword")?.value || "",
        newPassword: document.getElementById("user-newPassword")?.value || "",
        profilePicture: document.getElementById("profile-picture").getAttribute('src'), // <-- Grab selected new file (if any)
      };
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("user-id").textContent.trim();
        const name = document.getElementById("user-name").value;
        const email = document.getElementById("user-email").value;
        const phone = document.getElementById("user-phone")?.value || "";
        const role = document.getElementById("user-role")?.value || "";
        const isVerified = document.getElementById("user-isVerified")?.value || "";
        const oldpassword = document.getElementById("user-oldPassword")?.value.trim() || "";
        const newpassword = document.getElementById("user-newPassword")?.value.trim() || "";
        const profilePicture = document.getElementById("profile-picture").files[0]; // <-- Grab selected new file (if any)
        const currentPicture = document.getElementById("profile-picture-preview").getAttribute('src');

        
      
        // Check if anything has changed
        const hasChanged =
          name !== originalValues.name ||
          email !== originalValues.email ||
          phone !== originalValues.phone ||
          role !== originalValues.role ||
          isVerified !== originalValues.isVerified ||
          oldpassword !== "" ||
          newpassword !== ""||
          currentPicture !== originalValues.profilePicture; // <-- Check if a new file is selected
      
        if (!hasChanged) {
          showFunToast("‚ÑπÔ∏è No changes detected.", "red");
          return;
        }
      
        const body = { name, email, phone, role, isVerified };
      
        const formData = new FormData();
        formData.append("email", email);
        formData.append("phone", phone);
        formData.append("name", name);
        formData.append("role", role);
        formData.append("isVerified", isVerified);
        
        if (profilePicture) {
          formData.append("profilePicture", profilePicture);
        }

        if (oldpassword && newpassword) {
          formData.append("oldpassword", oldpassword);
          formData.append("newpassword", newpassword);
        } else if (oldpassword || newpassword) {
          showFunToast("‚ö†Ô∏è Fill BOTH old and new passwords!", "red");
          return;
        }


      
        try {
          const response = await fetch(`http://localhost:3000/api/users/${id}`, {
            method: "PUT",
            body: formData,
          });
      
          const data = await response.json();
      
          if (response.ok) {
            setTimeout(() => {
              showFunToast(
                data.message || "‚úÖ Updated successfully!",
                "green"
              );
              window.location.href = `/admin/${id}`; // üëâ Fixed redirect
            }, 1500);
          } else {
            showFunToast(data.message || "‚ùå Error occurred!", "red");
          }
        } catch (err) {
          console.error(err);
          showFunToast("‚ùå Error occurred!", "red");
        }
      });
      </script>
      
    
  </body>
</html>
